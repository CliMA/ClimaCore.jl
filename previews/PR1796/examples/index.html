<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Examples · ClimaCore.jl</title><meta name="title" content="Examples · ClimaCore.jl"/><meta property="og:title" content="Examples · ClimaCore.jl"/><meta property="twitter:title" content="Examples · ClimaCore.jl"/><meta name="description" content="Documentation for ClimaCore.jl."/><meta property="og:description" content="Documentation for ClimaCore.jl."/><meta property="twitter:description" content="Documentation for ClimaCore.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.png" alt="ClimaCore.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../">ClimaCore.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../intro/">Introduction</a></li><li><a class="tocitem" href="../math_framework/">Mathematical Framework</a></li><li><a class="tocitem" href="../installation_instructions/">Installation and How-to Guides</a></li><li><a class="tocitem" href="../operators/">Operators</a></li><li><a class="tocitem" href="../matrix_fields/">MatrixFields</a></li><li><a class="tocitem" href="../api/">API</a></li><li><input class="collapse-toggle" id="menuitem-8" type="checkbox"/><label class="tocitem" for="menuitem-8"><span class="docs-label">Developer docs</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../performance_tips/">Performance tips</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-9" type="checkbox"/><label class="tocitem" for="menuitem-9"><span class="docs-label">Tutorials</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../tutorials/introduction/">Introduction to ClimaCore.jl</a></li></ul></li><li class="is-active"><a class="tocitem" href>Examples</a><ul class="internal"><li><a class="tocitem" href="#1D-Column-examples"><span>1D Column examples</span></a></li><li><a class="tocitem" href="#2D-Cartesian-examples"><span>2D Cartesian examples</span></a></li><li><a class="tocitem" href="#3D-Cartesian-examples"><span>3D Cartesian examples</span></a></li><li><a class="tocitem" href="#2D-Sphere-examples"><span>2D Sphere examples</span></a></li><li><a class="tocitem" href="#3D-Sphere-examples"><span>3D Sphere examples</span></a></li></ul></li><li><input class="collapse-toggle" id="menuitem-11" type="checkbox"/><label class="tocitem" for="menuitem-11"><span class="docs-label">Libraries</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../lib/ClimaCorePlots/">ClimaCorePlots.jl</a></li><li><a class="tocitem" href="../lib/ClimaCoreMakie/">ClimaCoreMakie.jl</a></li><li><a class="tocitem" href="../lib/ClimaCoreVTK/">ClimaCoreVTK.jl</a></li><li><a class="tocitem" href="../lib/ClimaCoreTempestRemap/">ClimaCoreTempestRemap.jl</a></li><li><a class="tocitem" href="../lib/ClimaCoreSpectra/">ClimaCoreSpectra.jl</a></li></ul></li><li><a class="tocitem" href="../Contributing/">Contributing guide</a></li><li><a class="tocitem" href="../code_of_conduct/">Code of Conduct</a></li><li><a class="tocitem" href="../references/">References</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Examples</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Examples</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/CliMA/ClimaCore.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/CliMA/ClimaCore.jl/blob/main/docs/src/examples.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Examples"><a class="docs-heading-anchor" href="#Examples">Examples</a><a id="Examples-1"></a><a class="docs-heading-anchor-permalink" href="#Examples" title="Permalink"></a></h1><h2 id="1D-Column-examples"><a class="docs-heading-anchor" href="#1D-Column-examples">1D Column examples</a><a id="1D-Column-examples-1"></a><a class="docs-heading-anchor-permalink" href="#1D-Column-examples" title="Permalink"></a></h2><h2 id="2D-Cartesian-examples"><a class="docs-heading-anchor" href="#2D-Cartesian-examples">2D Cartesian examples</a><a id="2D-Cartesian-examples-1"></a><a class="docs-heading-anchor-permalink" href="#2D-Cartesian-examples" title="Permalink"></a></h2><h3 id="Flux-Limiters-advection"><a class="docs-heading-anchor" href="#Flux-Limiters-advection">Flux Limiters advection</a><a id="Flux-Limiters-advection-1"></a><a class="docs-heading-anchor-permalink" href="#Flux-Limiters-advection" title="Permalink"></a></h3><p>The 2D Cartesian advection/transport example in <a href="https://github.com/CliMA/ClimaCore.jl/tree/main/examples/plane/limiters_advection.jl"><code>examples/plane/limiters_advection.jl</code></a> demonstrates the application of flux limiters in the horizontal direction, namely <a href="https://clima.github.io/ClimaCore.jl/stable/api/#ClimaCore.Limiters.QuasiMonotoneLimiter"><code>QuasiMonotoneLimiter</code></a>, in a 2D Cartesian domain.</p><h4 id="Equations-and-discretizations"><a class="docs-heading-anchor" href="#Equations-and-discretizations">Equations and discretizations</a><a id="Equations-and-discretizations-1"></a><a class="docs-heading-anchor-permalink" href="#Equations-and-discretizations" title="Permalink"></a></h4><h4 id="Mass"><a class="docs-heading-anchor" href="#Mass">Mass</a><a id="Mass-1"></a><a class="docs-heading-anchor-permalink" href="#Mass" title="Permalink"></a></h4><p>Follows the continuity equation</p><p class="math-container">\[\begin{equation}
  \frac{\partial}{\partial t} \rho = - \nabla \cdot(\rho \boldsymbol{u}) .
\label{eq:2d-plane-advection-lim-continuity}
\end{equation}\]</p><p>This is discretized using the following</p><p class="math-container">\[\begin{equation}
  \frac{\partial}{\partial t} \rho \approx - wD[ \rho \boldsymbol{u}] .
\label{eq:2d-plane-advection-lim-discrete-continuity}
\end{equation}\]</p><h4 id="Tracers"><a class="docs-heading-anchor" href="#Tracers">Tracers</a><a id="Tracers-1"></a><a class="docs-heading-anchor-permalink" href="#Tracers" title="Permalink"></a></h4><p>For the tracer concentration per unit mass <span>$q$</span>, the tracer density (scalar) <span>$\rho q$</span> follows the advection/transport equation</p><p class="math-container">\[\begin{equation}
  \frac{\partial}{\partial t} \rho q = - \nabla \cdot(\rho q \boldsymbol{u})  + g(\rho, q).
\label{eq:2d-plane-advection-lim-tracers}
\end{equation}\]</p><p>This is discretized using the following</p><p class="math-container">\[\begin{equation}
\frac{\partial}{\partial t} \rho q \approx - wD[ \rho q \boldsymbol{u}] + g(\rho, q),
\label{eq:2d-plane-advection-lim-discrete-tracers}
\end{equation}\]</p><p>where <span>$g(\rho, q) = - \nu_4 [\nabla^4_h (\rho q)]$</span> represents the horizontal hyperdiffusion operator, with <span>$\nu_4$</span> (measured in m^4/s) the hyperviscosity constant coefficient (set equal to zero by default in the example).</p><p>Currently tracers are only treated explicitly in the time discretization.</p><h4 id="Prognostic-variables"><a class="docs-heading-anchor" href="#Prognostic-variables">Prognostic variables</a><a id="Prognostic-variables-1"></a><a class="docs-heading-anchor-permalink" href="#Prognostic-variables" title="Permalink"></a></h4><ul><li><span>$\rho$</span>: <em>density</em> measured in kg/m³.</li><li><span>$\boldsymbol{u}$</span> <em>velocity</em>, a vector measured in m/s. Since this is a 2D problem, <span>$\boldsymbol{u} \equiv \boldsymbol{u}_h$</span>.</li><li><span>$\rho q$</span>: the tracer density scalar, where <span>$q$</span> is the tracer concentration per unit mass.</li></ul><h4 id="Differentiation-operators"><a class="docs-heading-anchor" href="#Differentiation-operators">Differentiation operators</a><a id="Differentiation-operators-1"></a><a class="docs-heading-anchor-permalink" href="#Differentiation-operators" title="Permalink"></a></h4><p>Because this is a purely 2D problem, there is no staggered vertical discretization, hence, there is no need of specifying variables at cell centers, faces or to reconstruct from faces to centers and vice versa.</p><ul><li><span>$wD$</span> is the <a href="https://clima.github.io/ClimaCore.jl/stable/operators/#ClimaCore.Operators.WeakDivergence">discrete horizontal weak spectral divergence</a>, called <code>wdiv</code> in the example code.</li><li><span>$G$</span> is the <a href="https://clima.github.io/ClimaCore.jl/stable/operators/#ClimaCore.Operators.Gradient">discrete horizontal strong spectral gradient</a>, called <code>grad</code> in the example code.</li></ul><p>To discretize the hyperdiffusion operator, <span>$g(\rho, q) = - \nu_4 [\nabla^4 (\rho q)]$</span>, in the horizontal direction, we compose the horizontal weak divergence, <span>$wD$</span>, and the horizontal gradient operator, <span>$G_h$</span>, twice, with an intermediate call to <a href="https://clima.github.io/ClimaCore.jl/stable/api/#ClimaCore.Spaces.weighted_dss!"><code>weighted_dss!</code></a> between the two compositions, as in <span>$[g_2(\rho, g) \circ DSS(\rho, q) \circ g_1(\rho, q)]$</span>, with:</p><ul><li><span>$g_1(\rho, q) = wD(G_h(q))$</span></li><li><span>$DSS(\rho, q) = DSS(g_1(\rho q))$</span></li><li><span>$g_2(\rho, q) = -\nu_4 wD(\rho G_h(\rho q))$</span><ul><li>with <span>$\nu_4$</span> the hyperviscosity coefficient.</li></ul></li></ul><h4 id="Problem-flow-and-set-up"><a class="docs-heading-anchor" href="#Problem-flow-and-set-up">Problem flow and set-up</a><a id="Problem-flow-and-set-up-1"></a><a class="docs-heading-anchor-permalink" href="#Problem-flow-and-set-up" title="Permalink"></a></h4><p>This test case is set up in a Cartesian planar domain <span>$[-2 \pi, 2 \pi]^2$</span>, doubly periodic.</p><p>The flow was chosen to be a horizontal uniform rotation. Moreover, the flow is reversed halfway through the time period so that the tracer blobs go back to its initial configuration (using the same speed scaling constant which was derived to account for the distance travelled in all directions in a half period).</p><p class="math-container">\[\begin{align}
    u &amp;= -u_0 (y - c_y) \cos(\pi t / T_f) \nonumber \\
    v &amp;= u_0 (x - c_x) \cos(\pi t / T_f)
\label{eq:2d-plane-advection-lim-flow}
\end{align}\]</p><p>where <span>$u_0 = \pi / 2$</span> is the speed scaling factor to have the flow reversed halfway through the time period, <span>$\boldsymbol{c} = (c_x, c_y)$</span> is the center of the rotational flow, which coincides with the center of the domain, and <span>$T_f = 2 \pi$</span> is the final simulation time, which coincides with the temporal period to have a full rotation.</p><p>This example is set up to run with three possible initial conditions:</p><ul><li><code>cosine_bells</code></li><li><code>gaussian_bells</code></li><li><code>cylinders</code>: two 2D slotted cylinders (test case available in the literature, cfr: [<a href="../references/#GubaOpt2014">14</a>]).</li></ul><h4 id="Application-of-Flux-Limiters"><a class="docs-heading-anchor" href="#Application-of-Flux-Limiters">Application of Flux Limiters</a><a id="Application-of-Flux-Limiters-1"></a><a class="docs-heading-anchor-permalink" href="#Application-of-Flux-Limiters" title="Permalink"></a></h4><p>Because this is a fully 2D problem, the application of limiters does not affect the order of operations, which is implemented as follows:</p><ol><li>Horizontal trasport with hyperdiffusion (with weak divergence <span>$wD$</span>)</li><li>Horizontal flux limiters</li><li>DSS</li></ol><h2 id="3D-Cartesian-examples"><a class="docs-heading-anchor" href="#3D-Cartesian-examples">3D Cartesian examples</a><a id="3D-Cartesian-examples-1"></a><a class="docs-heading-anchor-permalink" href="#3D-Cartesian-examples" title="Permalink"></a></h2><h3 id="Flux-Limiters-advection-2"><a class="docs-heading-anchor" href="#Flux-Limiters-advection-2">Flux Limiters advection</a><a class="docs-heading-anchor-permalink" href="#Flux-Limiters-advection-2" title="Permalink"></a></h3><p>The 3D Cartesian advection/transport example in <a href="https://github.com/CliMA/ClimaCore.jl/tree/main/examples/hybrid/box/limiters_advection.jl"><code>examples/hybrid/box/limiters_advection.jl</code></a> demonstrates the application of flux limiters in the horizontal direction, namely <a href="https://clima.github.io/ClimaCore.jl/stable/api/#ClimaCore.Limiters.QuasiMonotoneLimiter"><code>QuasiMonotoneLimiter</code></a>, in a hybrid Cartesian domain. It also demonstrates the usage of the high-order upwinding scheme in the vertical direction, called <a href="https://clima.github.io/ClimaCore.jl/stable/operators/#ClimaCore.Operators.Upwind3rdOrderBiasedProductC2F"><code>Upwind3rdOrderBiasedProductC2F</code></a>.</p><h4 id="Equations-and-discretizations-2"><a class="docs-heading-anchor" href="#Equations-and-discretizations-2">Equations and discretizations</a><a class="docs-heading-anchor-permalink" href="#Equations-and-discretizations-2" title="Permalink"></a></h4><h4 id="Mass-2"><a class="docs-heading-anchor" href="#Mass-2">Mass</a><a class="docs-heading-anchor-permalink" href="#Mass-2" title="Permalink"></a></h4><p>Follows the continuity equation</p><p class="math-container">\[\begin{equation}
  \frac{\partial}{\partial t} \rho = - \nabla \cdot(\rho \boldsymbol{u}) .
\label{eq:3d-box-advection-lim-continuity}
\end{equation}\]</p><p>This is discretized using the following</p><p class="math-container">\[\begin{equation}
  \frac{\partial}{\partial t} \rho \approx - D_h[ \rho (\boldsymbol{u}_h + I^c(\boldsymbol{u}_v))] - D^c_v[I^f(\rho \boldsymbol{u}_h)) + I^f(\rho) \boldsymbol{u}_v)] .
\label{eq:3d-box-advection-lim-discrete-continuity}
\end{equation}\]</p><h4 id="Tracers-2"><a class="docs-heading-anchor" href="#Tracers-2">Tracers</a><a class="docs-heading-anchor-permalink" href="#Tracers-2" title="Permalink"></a></h4><p>For the tracer concentration per unit mass <span>$q$</span>, the tracer density (scalar) <span>$\rho q$</span> follows the advection/transport equation</p><p class="math-container">\[\begin{equation}
  \frac{\partial}{\partial t} \rho q = - \nabla \cdot(\rho q \boldsymbol{u})  + g(\rho, q).
\label{eq:3d-box-advection-lim-tracers}
\end{equation}\]</p><p>This is discretized using the following</p><p class="math-container">\[\begin{equation}
\frac{\partial}{\partial t} \rho q \approx
- D_h[ \rho q (\boldsymbol{u}_h + I^c(\boldsymbol{u}_v))]
- D^c_v\left[I^f(\rho q) U^f\left(I^f(\boldsymbol{u}_h) + \boldsymbol{u}_v, \frac{\rho q}{\rho} \right) \right] + g(\rho, q),
\label{eq:3d-box-advection-lim-discrete-tracers}
\end{equation}\]</p><p>where <span>$g(\rho, q) = - \nu_4 [\nabla^4_h (\rho q)]$</span> represents the horizontal hyperdiffusion operator, with <span>$\nu_4$</span> (measured in m^4/s) the hyperviscosity constant coefficient.</p><p>Currently tracers are only treated explicitly in the time discretization.</p><h4 id="Prognostic-variables-2"><a class="docs-heading-anchor" href="#Prognostic-variables-2">Prognostic variables</a><a class="docs-heading-anchor-permalink" href="#Prognostic-variables-2" title="Permalink"></a></h4><ul><li><span>$\rho$</span>: <em>density</em> measured in kg/m³. This is discretized at cell centers.</li><li><span>$\boldsymbol{u}$</span> <em>velocity</em>, a vector measured in m/s. This is discretized via <span>$\boldsymbol{u} = \boldsymbol{u}_h + \boldsymbol{u}_v$</span> where<ul><li><span>$\boldsymbol{u}_h = u_1 \boldsymbol{e}^1 + u_2 \boldsymbol{e}^2$</span> is the projection onto horizontal covariant components (covariance here means with respect to the reference element), stored at cell centers.</li><li><span>$\boldsymbol{u}_v = u_3 \boldsymbol{e}^3$</span> is the projection onto the vertical covariant components, stored at cell faces.</li></ul></li><li><span>$\rho q$</span>: the tracer density scalar, where <span>$q$</span> is the tracer concentration per unit mass, is stored at cell centers.</li></ul><h4 id="Operators"><a class="docs-heading-anchor" href="#Operators">Operators</a><a id="Operators-1"></a><a class="docs-heading-anchor-permalink" href="#Operators" title="Permalink"></a></h4><p>We make use of the following operators</p><h4 id="Reconstructions"><a class="docs-heading-anchor" href="#Reconstructions">Reconstructions</a><a id="Reconstructions-1"></a><a class="docs-heading-anchor-permalink" href="#Reconstructions" title="Permalink"></a></h4><ul><li><span>$I^c$</span> is the <a href="https://clima.github.io/ClimaCore.jl/stable/operators/#ClimaCore.Operators.InterpolateF2C">face-to-center reconstruction operator</a>, called <code>first_order_If2c</code> in the example code.</li><li><span>$I^f$</span> is the <a href="https://clima.github.io/ClimaCore.jl/stable/operators/#ClimaCore.Operators.InterpolateC2F">center-to-face reconstruction operator</a>, called <code>first_order_Ic2f</code> in the example code.<ul><li>Currently this is just the arithmetic mean, but we will need to use a weighted version with stretched vertical grids.</li></ul></li><li><span>$U^f$</span> is the <a href="https://clima.github.io/ClimaCore.jl/stable/operators/#ClimaCore.Operators.Upwind3rdOrderBiasedProductC2F">center-to-face upwind product operator</a>, called <code>third_order_upwind_c2f</code> in the example code<ul><li>This operator is of third-order of accuracy (when used with a constant vertical velocity and some reduced, but still high-order for non constant vertical velocity).</li></ul></li></ul><h4 id="Differentiation-operators-2"><a class="docs-heading-anchor" href="#Differentiation-operators-2">Differentiation operators</a><a class="docs-heading-anchor-permalink" href="#Differentiation-operators-2" title="Permalink"></a></h4><ul><li><span>$D_h$</span> is the <a href="https://clima.github.io/ClimaCore.jl/stable/operators/#ClimaCore.Operators.Divergence">discrete horizontal strong spectral divergence</a>, called <code>hdiv</code> in the example code.</li><li><span>$wD_h$</span> is the <a href="https://clima.github.io/ClimaCore.jl/stable/operators/#ClimaCore.Operators.WeakDivergence">discrete horizontal weak spectral divergence</a>, called <code>hwdiv</code> in the example code.</li><li><span>$D^c_v$</span> is the <a href="https://clima.github.io/ClimaCore.jl/stable/operators/#ClimaCore.Operators.DivergenceF2C">face-to-center vertical divergence</a>, called <code>vdivf2c</code> in the example code.<ul><li>This example uses advective fluxes equal to zero at the top and bottom boundaries.</li></ul></li><li><span>$G_h$</span> is the <a href="https://clima.github.io/ClimaCore.jl/stable/operators/#ClimaCore.Operators.Gradient">discrete horizontal spectral gradient</a>, called <code>hgrad</code> in the example code.</li></ul><p>To discretize the hyperdiffusion operator, <span>$g(\rho, q) = - \nu_4 [\nabla^4 (\rho q)]$</span>, in the horizontal direction, we compose the horizontal weak divergence, <span>$wD_h$</span>, and the horizontal gradient operator, <span>$G_h$</span>, twice, with an intermediate call to <a href="https://clima.github.io/ClimaCore.jl/stable/api/#ClimaCore.Spaces.weighted_dss!"><code>weighted_dss!</code></a> between the two compositions, as in <span>$[g_2(\rho, g) \circ DSS(\rho, q) \circ g_1(\rho, q)]$</span>, with:</p><ul><li><span>$g_1(\rho, q) = wD_h(G_h(q))$</span></li><li><span>$DSS(\rho, q) = DSS(g_1(\rho q))$</span></li><li><span>$g_2(\rho, q) = -\nu_4 wD_h(\rho G_h(\rho q))$</span><ul><li>with <span>$\nu_4$</span> the hyperviscosity coefficient.</li></ul></li></ul><h4 id="Application-of-Flux-Limiters-2"><a class="docs-heading-anchor" href="#Application-of-Flux-Limiters-2">Application of Flux Limiters</a><a class="docs-heading-anchor-permalink" href="#Application-of-Flux-Limiters-2" title="Permalink"></a></h4><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>Since we use flux limiters that limit only operators defined in the spectral space (i.e., they are applied level-wise in the horizontal direction), the application of limiters has to follow a precise order in the sequence of operations that specifies the total tendency.</p></div></div><p>The order of operations should be the following:</p><ol><li>Horizontal transport (with strong divergence <span>$D_h$</span>)</li><li>Horizontal Flux Limiters</li><li>Horizontal hyperdiffusion (with weak divergence <span>$wD_h$</span>)</li><li>Vertical transport</li><li>DSS</li></ol><h4 id="Problem-flow-and-set-up-2"><a class="docs-heading-anchor" href="#Problem-flow-and-set-up-2">Problem flow and set-up</a><a class="docs-heading-anchor-permalink" href="#Problem-flow-and-set-up-2" title="Permalink"></a></h4><p>This test case is set up in a Cartesian (box) domain <span>$[-2 \pi, 2 \pi]^2 \times [0, 4 \pi] ~\textrm{m}^3$</span>, doubly periodic in the horizontal direction, but not in the vertical direction.</p><p>The flow was chosen to be a spiral, i.e., so to have a horizontal uniform rotation, and a vertical velocity <span>$\boldsymbol{u}_v \equiv w = 0$</span> at the top and bottom boundaries, and <span>$\boldsymbol{u}_v \equiv w = 1$</span> in the center of the domain. Moreover, the flow is reversed in all directions halfway through the time period so that the tracer blobs go back to its initial configuration (using the same speed scaling constant which was derived to account for the distance travelled in all directions in a half period).</p><p class="math-container">\[\begin{align}
    u &amp;= -u_0 (y - c_y) \cos(\pi t / T_f) \nonumber \\
    v &amp;= u_0 (x - c_x) \cos(\pi t / T_f) \nonumber \\
    w &amp;= u_0 \sin(\pi z / z_m) \cos(\pi t / T_f) \nonumber
\label{eq:3d-box-advection-lim-flow}
\end{align}\]</p><p>where <span>$u_0 = \pi / 2$</span> is the speed scaling factor to have the flow reversed halfway through the time period, <span>$\boldsymbol{c} = (c_x, c_y)$</span> is the center of the rotational flow, which coincides with the center of the domain,  <span>$z_m = 4 \pi$</span> is the maximum height of the domain, and <span>$T_f = 2 \pi$</span> is the final simulation time, which coincides with the temporal period to have a full rotation in the horizontal direction.</p><p>This example is set up to run with three possible initial conditions:</p><ul><li><code>cosine_bells</code></li><li><code>gaussian_bells</code></li><li><code>slotted_spheres</code>: a slight modification of the 2D slotted cylinder test case available in the literature (cfr: [<a href="../references/#GubaOpt2014">14</a>]).</li></ul><h4 id="Application-of-Flux-Limiters-3"><a class="docs-heading-anchor" href="#Application-of-Flux-Limiters-3">Application of Flux Limiters</a><a class="docs-heading-anchor-permalink" href="#Application-of-Flux-Limiters-3" title="Permalink"></a></h4><p>Because this is a Cartesian 3D problem, the application of limiters does not affect the order of operations, which is implemented as follows:</p><ol><li>Horizontal transport + hyperdiffusion (with weak divergence <span>$wD_h$</span>)</li><li>Horizontal flux limiters</li><li>Vertical transport</li><li>DSS</li></ol><h2 id="2D-Sphere-examples"><a class="docs-heading-anchor" href="#2D-Sphere-examples">2D Sphere examples</a><a id="2D-Sphere-examples-1"></a><a class="docs-heading-anchor-permalink" href="#2D-Sphere-examples" title="Permalink"></a></h2><h3 id="Flux-Limiters-advection-3"><a class="docs-heading-anchor" href="#Flux-Limiters-advection-3">Flux Limiters advection</a><a class="docs-heading-anchor-permalink" href="#Flux-Limiters-advection-3" title="Permalink"></a></h3><p>The 2D sphere advection/transport example in <a href="https://github.com/CliMA/ClimaCore.jl/tree/main/examples/sphere/limiters_advection.jl"><code>examples/sphere/limiters_advection.jl</code></a> demonstrates the application of flux limiters in the horizontal direction, namely <a href="https://clima.github.io/ClimaCore.jl/stable/api/#ClimaCore.Limiters.QuasiMonotoneLimiter"><code>QuasiMonotoneLimiter</code></a>, in a 2D spherical domain.</p><h4 id="Equations-and-discretizations-3"><a class="docs-heading-anchor" href="#Equations-and-discretizations-3">Equations and discretizations</a><a class="docs-heading-anchor-permalink" href="#Equations-and-discretizations-3" title="Permalink"></a></h4><h4 id="Mass-3"><a class="docs-heading-anchor" href="#Mass-3">Mass</a><a class="docs-heading-anchor-permalink" href="#Mass-3" title="Permalink"></a></h4><p>Follows the continuity equation</p><p class="math-container">\[\begin{equation}
  \frac{\partial}{\partial t} \rho = - \nabla \cdot(\rho \boldsymbol{u}) .
\label{eq:2d-sphere-advection-lim-continuity}
\end{equation}\]</p><p>This is discretized using the following</p><p class="math-container">\[\begin{equation}
  \frac{\partial}{\partial t} \rho \approx - wD[ \rho \boldsymbol{u}] .
\label{eq:2d-sphere-advection-lim-discrete-continuity}
\end{equation}\]</p><h4 id="Tracers-3"><a class="docs-heading-anchor" href="#Tracers-3">Tracers</a><a class="docs-heading-anchor-permalink" href="#Tracers-3" title="Permalink"></a></h4><p>For the tracer concentration per unit mass <span>$q$</span>, the tracer density (scalar) <span>$\rho q$</span> follows the advection/transport equation</p><p class="math-container">\[\begin{equation}
  \frac{\partial}{\partial t} \rho q = - \nabla \cdot(\rho q \boldsymbol{u})  + g(\rho, q).
\label{eq:2d-sphere-advection-lim-tracers}
\end{equation}\]</p><p>This is discretized using the following</p><p class="math-container">\[\begin{equation}
\frac{\partial}{\partial t} \rho q \approx - wD[ \rho q \boldsymbol{u}] + g(\rho, q),
\label{eq:2d-sphere-advection-lim-discrete-tracers}
\end{equation}\]</p><p>where <span>$g(\rho, q) = - \nu_4 [\nabla^4_h (\rho q)]$</span> represents the horizontal hyperdiffusion operator, with <span>$\nu_4$</span> (measured in m^4/s) the hyperviscosity constant coefficient.</p><p>Currently tracers are only treated explicitly in the time discretization.</p><h4 id="Prognostic-variables-3"><a class="docs-heading-anchor" href="#Prognostic-variables-3">Prognostic variables</a><a class="docs-heading-anchor-permalink" href="#Prognostic-variables-3" title="Permalink"></a></h4><ul><li><span>$\rho$</span>: <em>density</em> measured in kg/m³.</li><li><span>$\boldsymbol{u}$</span> <em>velocity</em>, a vector measured in m/s. Since this is a 2D problem, <span>$\boldsymbol{u} \equiv \boldsymbol{u}_h$</span>.</li><li><span>$\rho q$</span>: the tracer density scalar, where <span>$q$</span> is the tracer concentration per unit mass.</li></ul><h4 id="Differentiation-operators-3"><a class="docs-heading-anchor" href="#Differentiation-operators-3">Differentiation operators</a><a class="docs-heading-anchor-permalink" href="#Differentiation-operators-3" title="Permalink"></a></h4><p>Because this is a purely 2D problem, there is no staggered vertical discretization, hence, there is no need of specifying variables at cell centers, faces or to reconstruct from faces to centers and vice versa.</p><ul><li><span>$wD$</span> is the <a href="https://clima.github.io/ClimaCore.jl/stable/operators/#ClimaCore.Operators.WeakDivergence">discrete horizontal weak spectral divergence</a>, called <code>wdiv</code> in the example code.</li><li><span>$G$</span> is the <a href="https://clima.github.io/ClimaCore.jl/stable/operators/#ClimaCore.Operators.Gradient">discrete horizontal strong spectral gradient</a>, called <code>grad</code> in the example code.</li></ul><p>To discretize the hyperdiffusion operator, <span>$g(\rho, q) = - \nu_4 [\nabla^4 (\rho q)]$</span>, in the horizontal direction, we compose the horizontal weak divergence, <span>$wD$</span>, and the horizontal gradient operator, <span>$G_h$</span>, twice, with an intermediate call to <a href="https://clima.github.io/ClimaCore.jl/stable/api/#ClimaCore.Spaces.weighted_dss!"><code>weighted_dss!</code></a> between the two compositions, as in <span>$[g_2(\rho, g) \circ DSS(\rho, q) \circ g_1(\rho, q)]$</span>, with:</p><ul><li><span>$g_1(\rho, q) = wD(G_h(q))$</span></li><li><span>$DSS(\rho, q) = DSS(g_1(\rho q))$</span></li><li><span>$g_2(\rho, q) = -\nu_4 wD(\rho G_h(\rho q))$</span><ul><li>with <span>$\nu_4$</span> the hyperviscosity coefficient.</li></ul></li></ul><h4 id="Problem-flow-and-set-up-3"><a class="docs-heading-anchor" href="#Problem-flow-and-set-up-3">Problem flow and set-up</a><a class="docs-heading-anchor-permalink" href="#Problem-flow-and-set-up-3" title="Permalink"></a></h4><p>This test case is set up in a Cartesian planar domain <span>$[-2 \pi, 2 \pi]^2$</span>, doubly periodic.</p><p>The flow was chosen to be a horizontal uniform rotation. Moreover, the flow is reversed halfway through the time period so that the tracer blobs go back to its initial configuration (using the same speed scaling constant which was derived to account for the distance travelled in all directions in a half period).</p><p class="math-container">\[\begin{align}
    u &amp;= k sin (\lambda)^2  sin (2  \phi)  \cos(\pi  t / T_f) +
       \frac{2 \pi}{T_f} \cos (\phi) \nonumber \\
    v &amp;= k \sin (2  \lambda) \cos (\phi) \cos(\pi t / T_f)
\label{eq:2d-sphere-lim-flow}
\end{align}\]</p><p>where <span>$u_0 = 2 \pi R / T_f$</span> is the speed scaling factor to have the flow reversed halfway through the time period, <span>$T_f = 86400 * 12$</span> (i.e., <span>$12$</span> days in seconds) is the final simulation time, which coincides with the temporal period to have a full rotation around the sphere of radius <span>$R$</span>.</p><p>This example is set up to run with three possible initial conditions:</p><ul><li><code>cosine_bells</code></li><li><code>gaussian_bells</code></li><li><code>cylinders</code>: two 2D slotted cylinders (test case available in the literature, cfr: [<a href="../references/#GubaOpt2014">14</a>]).</li></ul><h4 id="Application-of-Flux-Limiters-4"><a class="docs-heading-anchor" href="#Application-of-Flux-Limiters-4">Application of Flux Limiters</a><a class="docs-heading-anchor-permalink" href="#Application-of-Flux-Limiters-4" title="Permalink"></a></h4><p>Because this is a fully 2D problem, the application of limiters does not affect the order of operations, which is implemented as follows:</p><ol><li>Horizontal trasport with hyperdiffusion (with weak divergence <span>$wD$</span>)</li><li>Horizontal flux limiters</li><li>DSS</li></ol><h3 id="Shallow-water-equations"><a class="docs-heading-anchor" href="#Shallow-water-equations">Shallow-water equations</a><a id="Shallow-water-equations-1"></a><a class="docs-heading-anchor-permalink" href="#Shallow-water-equations" title="Permalink"></a></h3><p>The shallow water equations in the so-called <em>vector invariant form</em> from [<a href="../references/#Bao2014">15</a>] are:</p><p class="math-container">\[\begin{align}
  \frac{\partial h}{\partial t} + \nabla \cdot (h u) &amp;= 0\\
  \frac{\partial u_i}{\partial t} + \nabla (\Phi + \tfrac{1}{2}\|u\|^2)_i  &amp;= (\boldsymbol{u} \times (f + \nabla \times \boldsymbol{u}))_i
\label{eq:shallow-water}
\end{align}\]</p><p>where <span>$f$</span> is the Coriolis term and <span>$\Phi = g(h+h_s)$</span>, with <span>$g$</span> the gravitational accelration constant, <span>$h$</span> the (free) height of the fluid and  <span>$h_s$</span> a non-uniform reference surface.</p><p>To the above set of equations, we allow the uset to add a hyperdiffusion operator, <span>$g(h, \boldsymbol{u}) = - \nu_4 [\nabla^4 (h, \boldsymbol{u})]$</span>, with <span>$\nu_4$</span> (measured in m^4/s) the hyperviscosity constant coefficient. In the hyperdiffusion expression, <span>$\nabla^4$</span> represents a biharmonic operator, and it assumes a different formulation on curvilinear reference systems, depending on it being applied to a scalar field, such as <span>$h$</span>, or a vector field, such as <span>$\boldsymbol{u}$</span>.</p><p>The governing equations then become:</p><p class="math-container">\[\begin{align}
  \frac{\partial h}{\partial t} + \nabla \cdot (h u) &amp;= g(h, \boldsymbol{u})\\
  \frac{\partial u_i}{\partial t} + \nabla (\Phi + \tfrac{1}{2}\|u\|^2)_i  &amp;= (\boldsymbol{u} \times (f + \nabla \times \boldsymbol{u}))_i + g(h, \boldsymbol{u})
\label{eq:shallow-water-with-hyperdiff}
\end{align}\]</p><p>Since this is a 2D problem (with related 2D vector field), the curl is defined to be</p><p class="math-container">\[\begin{align}
 \omega^i = (\nabla \times u)^i &amp;=
    \begin{cases}
        0 &amp;\text{ if $i =1,2$},\\
        \frac{1}{J} \left[ \frac{\partial u_2}{\partial \xi^1} - \frac{\partial u_1}{\partial \xi^2} \right] &amp;\text{ if $i=3$},
    \end{cases}
\label{eq:2Dvorticity}
\end{align}\]</p><p>where we have used the coordinate system in each 2D reference element, i.e., <span>$(\xi^1, \xi^2) \in [-1,1]\times[-1,1]$</span>. Similarly, if additionally <span>$v^1 = v^2 = 0$</span>, then</p><p class="math-container">\[\begin{align}
   (\boldsymbol{u} \times \boldsymbol{v})_i =
    \begin{cases}
          J u^2 v^3 &amp;\text{ if $i=1$},\\
        - J u^1 v^3 &amp;\text{ if $i=2$},\\
        0 &amp;\text{ if $i=3$}.
    \end{cases}
\end{align}\]</p><p>Hence, we can rewrite equations \eqref{eq:shallow-water} using the velocity representation in covariant coordinates, in this case <span>$u = u_1 \boldsymbol{b}^1 + u_2 \boldsymbol{b}^2 + 0\boldsymbol{b}^3$</span>, and <span>$g(h, \boldsymbol{u}) = 0$</span> for simplicity, as:</p><p class="math-container">\[\begin{align}
    \frac{\partial h}{\partial t} + \frac{1}{J}\frac{\partial}{\partial \xi^j}\Big(h J u^j\Big) &amp;= 0\\
    \frac{\partial u_i}{\partial t} + \frac{\partial}{\partial \xi^i} (\Phi + \tfrac{1}{2}\|u\|^2)  &amp;= E_{ijk}u^j (f^k + \omega^k) .
\label{eq:covariant-shallow-water}
\end{align}\]</p><h4 id="Prognostic-variables-4"><a class="docs-heading-anchor" href="#Prognostic-variables-4">Prognostic variables</a><a class="docs-heading-anchor-permalink" href="#Prognostic-variables-4" title="Permalink"></a></h4><ul><li><span>$h$</span>: scalar <em>height</em> field of the fluid, measured in m.</li><li><span>$\boldsymbol{u}$</span> <em>velocity</em>, a 2D vector measured in m/s.</li></ul><h4 id="Differentiation-operators-4"><a class="docs-heading-anchor" href="#Differentiation-operators-4">Differentiation operators</a><a class="docs-heading-anchor-permalink" href="#Differentiation-operators-4" title="Permalink"></a></h4><p>Because this is a purely 2D problem, there is no staggered vertical discretization, hence, there is no need of specifying variables at cell centers, faces or to reconstruct from faces to centers and vice versa.</p><ul><li><span>$D$</span> is the <a href="https://clima.github.io/ClimaCore.jl/stable/operators/#ClimaCore.Operators.Divergence">discrete horizontal strong spectral divergence</a>, called <code>div</code> in the example code.</li><li><span>$wD$</span> is the <a href="https://clima.github.io/ClimaCore.jl/stable/operators/#ClimaCore.Operators.WeakDivergence">discrete horizontal weak spectral divergence</a>, called <code>wdiv</code> in the example code.</li><li><span>$G$</span> is the <a href="https://clima.github.io/ClimaCore.jl/stable/operators/#ClimaCore.Operators.Gradient">discrete horizontal strong spectral gradient</a>, called <code>grad</code> in the example code.</li><li><span>$wG$</span> is the <a href="https://clima.github.io/ClimaCore.jl/stable/operators/#ClimaCore.Operators.WeakGradient">discrete horizontal weak spectral gradient</a>, called <code>wgrad</code> in the example code.</li><li><span>$Curl$</span> is the <a href="https://clima.github.io/ClimaCore.jl/stable/operators/#ClimaCore.Operators.Curl">discrete curl</a>, called <code>curl</code> in the example code.</li><li><span>$wCurl$</span> is the <a href="https://clima.github.io/ClimaCore.jl/stable/operators/#ClimaCore.Operators.WeakCurl">discrete weak curl</a>, called <code>wcurl</code> in the example code.</li></ul><p>To discretize the hyperdiffusion operator, <span>$g(h, \boldsymbol{u}) = - \nu_4 [\nabla^4 (h, \boldsymbol{u})]$</span>, in the horizontal direction, we compose the weak divergence, <span>$wD$</span>, and the gradient operator, <span>$G$</span>, twice, with an intermediate call to <a href="https://clima.github.io/ClimaCore.jl/stable/api/#ClimaCore.Spaces.weighted_dss!"><code>weighted_dss!</code></a> between the two compositions, as in <span>$[g_2(h, \boldsymbol{u}) \circ DSS(h, \boldsymbol{u}) \circ g_1(h, \boldsymbol{u})]$</span>. Moreover, when <span>$g(h, \boldsymbol{u}) = - \nu_4 [\nabla^4 (h)]$</span>, i.e., the operator is applied to a scalar field only, it is discretized composing the following operations:</p><ul><li><span>$g_1(h) = wD(G(h))$</span></li><li><span>$DSS(g_1(h))$</span></li><li><span>$g_2(h) = -\nu_4 wD(G(h))$</span></li></ul><p>whereas, when the operator is applied to a vector field, i.e., <span>$g(h, \boldsymbol{u}) = - \nu_4 [\nabla^4 (\boldsymbol{u})]$</span>, it is discretized as:</p><ul><li><span>$g_1(h, \boldsymbol{u}) = wG(D(\boldsymbol{u})) - wCurl(Curl(\boldsymbol{u}))$</span></li><li><span>$DSS(h, \boldsymbol{u}) = DSS(g_1(h, \boldsymbol{u}))$</span></li><li><span>$g_2(h, \boldsymbol{u}) = -\nu_4 \left[ wG(D(\boldsymbol{u})) - wCurl(Curl(\boldsymbol{u})) \right]$</span></li></ul><p>In both cases, <span>$\nu_4$</span> is the hyperviscosity coefficient.</p><h4 id="Problem-flow-and-set-up-4"><a class="docs-heading-anchor" href="#Problem-flow-and-set-up-4">Problem flow and set-up</a><a class="docs-heading-anchor-permalink" href="#Problem-flow-and-set-up-4" title="Permalink"></a></h4><p>This test case is set up on a 2D (surface) spherical domain represented by a cubed-sphere manifold.</p><p>This suite of examples contains five different test cases:</p><ul><li>One, invoked via the command-line argument <code>steady_state</code>, which reproduces Test Case 2 in [<a href="../references/#Williamson1992">16</a>]. This test case gives the steady-state solution to the non-linear shallow water equations. It consists of a solid body rotation or zonal flow with the corresponding geostrophic height field. The Coriolis parameter is a function of latitude and longitude so the flow can be specified with the spherical coordinate poles not necessarily coincident with Earth&#39;s rotation axis. Hence, this test case can be run with a specified command-line argument for the angle <span>$\alpha$</span> that represents the angle between the north pole and the center of the top cube panel of the cubed-sphere geometry.</li><li>A second one, invoked via the command-line argument <code>steady_state_compact</code>, reproduces Test Case 3 in [<a href="../references/#Williamson1992">16</a>]. This test case gives the steady-state solution to the non-linear shallow water equations with nonlinear zonal geostrophic flow with compact support.</li><li>A third one, invoked via the command-line argument <code>mountain</code>, reproduces Test Case 5 in [<a href="../references/#Williamson1992">16</a>]. It represents a zonal flow over an isolated mountain, where the governing equations describe a global steady-state nonlinear zonal geostrophic flow, with a corresponding geostrophic height field over a non-uniform reference surface <code>h_s</code>.</li><li>A fourth one, invoked via the command-line argument <code>rossby_haurwitz</code>, reproduces Test Case 6 in [<a href="../references/#Williamson1992">16</a>]. It represents the solution of the nonlinear barotropic vorticity equation on the sphere.</li><li>A fifth one, invoked via the command-line argument <code>barotropic_instability</code>, reproduces the test case in [<a href="../references/#Galewsky2004">17</a>] (also in Sec. 7.6 in [<a href="../references/#Ullrich2010">18</a>]). This test case consists of a zonal jet with compact support at a latitude of <span>$45°$</span>. A small height disturbance is then added, which causes the jet to become unstable and collapse into a highly vortical structure.</li></ul><h2 id="3D-Sphere-examples"><a class="docs-heading-anchor" href="#3D-Sphere-examples">3D Sphere examples</a><a id="3D-Sphere-examples-1"></a><a class="docs-heading-anchor-permalink" href="#3D-Sphere-examples" title="Permalink"></a></h2><h3 id="Deformation-Flow-with-Flux-Limiters"><a class="docs-heading-anchor" href="#Deformation-Flow-with-Flux-Limiters">Deformation Flow with Flux Limiters</a><a id="Deformation-Flow-with-Flux-Limiters-1"></a><a class="docs-heading-anchor-permalink" href="#Deformation-Flow-with-Flux-Limiters" title="Permalink"></a></h3><p>The 3D sphere advection/transport example in <a href="https://github.com/CliMA/ClimaCore.jl/tree/main/examples/hybrid/sphere/deformation_flow.jl"><code>examples/hybrid/sphere/deformation_flow.jl</code></a> demonstrates the application of flux limiters in the horziontal direction, namely <a href="https://clima.github.io/ClimaCore.jl/stable/api/#ClimaCore.Limiters.QuasiMonotoneLimiter"><code>QuasiMonotoneLimiter</code></a>, in a hybrid 3D spherical domain. It also demonstrates the usage of the flux-corrected transport in the vertical direction; by default, it uses <code>FCTZalesak</code>.</p><h4 id="Equations-and-discretizations-4"><a class="docs-heading-anchor" href="#Equations-and-discretizations-4">Equations and discretizations</a><a class="docs-heading-anchor-permalink" href="#Equations-and-discretizations-4" title="Permalink"></a></h4><p>The original test case (without limiters or flux-corrected transport) is specified in Section 1.1 of [<a href="../references/#Ullrich2012DynamicalCM">19</a>].</p><h4 id="Mass-4"><a class="docs-heading-anchor" href="#Mass-4">Mass</a><a class="docs-heading-anchor-permalink" href="#Mass-4" title="Permalink"></a></h4><p>Follows the continuity equation</p><p class="math-container">\[\begin{equation}
  \frac{\partial}{\partial t} \rho = - \nabla \cdot(\rho \boldsymbol{u}) .
\label{eq:3d-sphere-lim-continuity}
\end{equation}\]</p><p>This is discretized using the following</p><p class="math-container">\[\begin{equation}
  \frac{\partial}{\partial t} \rho \approx - D_h[\rho \boldsymbol{u}^c] - D^c_v[I^f(\rho) \boldsymbol{u}^f].
\label{eq:3d-sphere-lim-discrete-continuity}
\end{equation}\]</p><h4 id="Tracers-4"><a class="docs-heading-anchor" href="#Tracers-4">Tracers</a><a class="docs-heading-anchor-permalink" href="#Tracers-4" title="Permalink"></a></h4><p>This test case has five different tracer concentrations per unit mass <span>$q_i$</span>, hence five different tracer densities (scalar) <span>$\rho q_i$</span>. They all follow the same advection/transport equation</p><p class="math-container">\[\begin{equation}
  \frac{\partial}{\partial t} \rho q = - \nabla \cdot(\rho q \boldsymbol{u})  + g(\rho, q).
\label{eq:3d-sphere-lim-tracers}
\end{equation}\]</p><p>This is discretized using the following</p><p class="math-container">\[\begin{equation}
\frac{\partial}{\partial t} \rho q \approx
- D_h[ \rho q \boldsymbol{u}^c]
- D^c_v\left[I^f(\rho q) * \boldsymbol{u}^f_h + FCT^f\left( \boldsymbol{u}^f_v, \frac{\rho q}{\rho} \right) \right] + g(\rho, q),
\label{eq:3d-sphere-lim-discrete-tracers}
\end{equation}\]</p><p>where <span>$g(\rho, q) = - \nu_4 [\nabla^4_h (\rho q)]$</span> represents the horizontal hyperdiffusion operator, with <span>$\nu_4$</span> (measured in m^4/s) the hyperviscosity constant coefficient.</p><p>Currently tracers are only treated explicitly in the time discretization.</p><h4 id="Prognostic-variables-5"><a class="docs-heading-anchor" href="#Prognostic-variables-5">Prognostic variables</a><a class="docs-heading-anchor-permalink" href="#Prognostic-variables-5" title="Permalink"></a></h4><ul><li><span>$\rho$</span>: <em>density</em> measured in kg/m³. This is discretized at cell centers.</li><li><span>$\boldsymbol{u}$</span> <em>velocity</em>, a vector measured in m/s. This is discretized via <span>$\boldsymbol{u} = \boldsymbol{u}_h + \boldsymbol{u}_v$</span> where<ul><li><span>$\boldsymbol{u}_h = u_1 \boldsymbol{e}^1 + u_2 \boldsymbol{e}^2$</span> is the projection onto horizontal covariant components (covariance here means with respect to the reference element), stored at cell centers.</li><li><span>$\boldsymbol{u}_v = u_3 \boldsymbol{e}^3$</span> is the projection onto the vertical covariant components, stored at cell faces.</li></ul></li><li><span>$\rho q_i$</span>: tracer density scalars, where <span>$q_i$</span> is a tracer concentration per unit mass, are stored at cell centers.</li></ul><h4 id="Operators-2"><a class="docs-heading-anchor" href="#Operators-2">Operators</a><a class="docs-heading-anchor-permalink" href="#Operators-2" title="Permalink"></a></h4><p>We make use of the following operators</p><h4 id="Reconstructions-2"><a class="docs-heading-anchor" href="#Reconstructions-2">Reconstructions</a><a class="docs-heading-anchor-permalink" href="#Reconstructions-2" title="Permalink"></a></h4><ul><li><span>$I^c$</span> is the <a href="https://clima.github.io/ClimaCore.jl/stable/operators/#ClimaCore.Operators.InterpolateF2C">face-to-center reconstruction operator</a>, called <code>If2c</code> in the example code.</li><li><span>$I^f$</span> is the <a href="https://clima.github.io/ClimaCore.jl/stable/operators/#ClimaCore.Operators.InterpolateC2F">center-to-face reconstruction operator</a>, called <code>Ic2f</code> in the example code.<ul><li>Currently this is just the arithmetic mean, but we will need to use a weighted version with stretched vertical grids.</li></ul></li><li><span>$FCT^f$</span> denotes either the <a href="https://clima.github.io/ClimaCore.jl/stable/operators/#ClimaCore.Operators.Upwind3rdOrderBiasedProductC2F">center-to-face upwind product operator</a> (which represents no flux-corrected transport), the center-to-face Boris &amp; Book FCT operator, or the center-to-face Zalesak FCT operator.</li></ul><h4 id="Differentiation-operators-5"><a class="docs-heading-anchor" href="#Differentiation-operators-5">Differentiation operators</a><a class="docs-heading-anchor-permalink" href="#Differentiation-operators-5" title="Permalink"></a></h4><ul><li><span>$D_h$</span> is the <a href="https://clima.github.io/ClimaCore.jl/stable/operators/#ClimaCore.Operators.Divergence">discrete horizontal strong spectral divergence</a>, called <code>hdiv</code> in the example code.</li><li><span>$wD_h$</span> is the <a href="https://clima.github.io/ClimaCore.jl/stable/operators/#ClimaCore.Operators.WeakDivergence">discrete horizontal weak spectral divergence</a>, called <code>hwdiv</code> in the example code.</li><li><span>$D^c_v$</span> is the <a href="https://clima.github.io/ClimaCore.jl/stable/operators/#ClimaCore.Operators.DivergenceF2C">face-to-center vertical divergence</a>, called <code>vdivf2c</code> in the example code.<ul><li>This example uses advective fluxes equal to zero at the top and bottom boundaries.</li></ul></li><li><span>$G_h$</span> is the <a href="https://clima.github.io/ClimaCore.jl/stable/operators/#ClimaCore.Operators.Gradient">discrete horizontal spectral gradient</a>, called <code>hgrad</code> in the example code.</li></ul><p>To discretize the hyperdiffusion operator for each tracer concentration, <span>$g(\rho, q_i) = - \nu_4 [\nabla^4 (\rho q_i)]$</span>, in the horizontal direction, we compose the horizontal weak divergence, <span>$wD_h$</span>, and the horizontal gradient operator, <span>$G_h$</span>, twice, with an intermediate call to <a href="https://clima.github.io/ClimaCore.jl/stable/api/#ClimaCore.Spaces.weighted_dss!"><code>weighted_dss!</code></a> between the two compositions, as in <span>$[g_2(\rho, g) \circ DSS(\rho, q) \circ g_1(\rho, q_i)]$</span>, with:</p><ul><li><span>$g_1(\rho, q_i) = wD_h(G_h(q_i))$</span></li><li><span>$DSS(\rho, q_i) = DSS(g_1(\rho q_i))$</span></li><li><span>$g_2(\rho, q_i) = -\nu_4 wD_h(\rho G_h(\rho q_i))$</span><ul><li>with <span>$\nu_4$</span> the hyperviscosity coefficient.</li></ul></li></ul><h4 id="Application-of-Flux-Limiters-5"><a class="docs-heading-anchor" href="#Application-of-Flux-Limiters-5">Application of Flux Limiters</a><a class="docs-heading-anchor-permalink" href="#Application-of-Flux-Limiters-5" title="Permalink"></a></h4><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>Since we use flux limiters that limit only operators defined in the spectral space (i.e., they are applied level-wise in the horizontal direction), the application of limiters has to follow a precise order in the sequence of operations that specifies the total tendency.</p></div></div><p>The order of operations should be the following:</p><ol><li>Horizontal transport (with strong divergence <span>$D_h$</span>)</li><li>Horizontal flux limiters</li><li>Horizontal hyperdiffusion (with weak divergence <span>$wD_h$</span>)</li><li>Vertical transport</li><li>DSS</li></ol><h4 id="Problem-flow-and-set-up-5"><a class="docs-heading-anchor" href="#Problem-flow-and-set-up-5">Problem flow and set-up</a><a class="docs-heading-anchor-permalink" href="#Problem-flow-and-set-up-5" title="Permalink"></a></h4><p>This test case is set up in a 3D (shell) spherical domain where the elevation goes from <span>$z=0~\textrm{m}$</span> (i.e., from the radius of the sphere <span>$R = 6.37122 10^6~\textrm{m}$</span>) to <span>$z_{\textrm{top}} = 12000~\textrm{m}$</span>.</p><p>The flow (reversed halfway through the time period) is specified as <span>$\boldsymbol{u} = \boldsymbol{u}_a + \boldsymbol{u}_d$</span>, where the components are defined as follows:</p><p class="math-container">\[\begin{align}
  u_a &amp;= k \sin (\lambda&#39;)^2  \sin (2  \phi)  \cos(\pi  t / \tau) +
      \frac{2 \pi R}{\tau} \cos (\phi) \nonumber \\
  v_a &amp;= k \sin (2  \lambda&#39;) \cos (\phi) \cos(\pi t / \tau) \nonumber \\
  u_d &amp;= \frac{\omega_0  R}{ b / p_{\textrm{top}}} \cos (\lambda&#39;) \cos(\phi)^2 \cos(2 \pi t / \tau) \left[-exp \left( \frac{(p - p_0)}{ b p_{\textrm{top}}} \right) + exp \left( \frac{(p_{\textrm{top}} - p(zc))}{b p_{\textrm{top}}} \right) \right] \nonumber
\label{eq:3d-sphere-lim-flow}
\end{align}\]</p><p>where all values of the parameters can be found in Table 1.1 in the reference [<a href="../references/#Ullrich2012DynamicalCM">19</a>].</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../tutorials/introduction/">« Introduction to ClimaCore.jl</a><a class="docs-footer-nextpage" href="../lib/ClimaCorePlots/">ClimaCorePlots.jl »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.4.1 on <span class="colophon-date" title="Tuesday 11 June 2024 20:05">Tuesday 11 June 2024</span>. Using Julia version 1.10.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
