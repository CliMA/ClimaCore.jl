<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Remapping · ClimaCore.jl</title><meta name="title" content="Remapping · ClimaCore.jl"/><meta property="og:title" content="Remapping · ClimaCore.jl"/><meta property="twitter:title" content="Remapping · ClimaCore.jl"/><meta name="description" content="Documentation for ClimaCore.jl."/><meta property="og:description" content="Documentation for ClimaCore.jl."/><meta property="twitter:description" content="Documentation for ClimaCore.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.png" alt="ClimaCore.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../">ClimaCore.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../intro/">Introduction</a></li><li><a class="tocitem" href="../math_framework/">Mathematical Framework</a></li><li><a class="tocitem" href="../installation_instructions/">Installation and How-to Guides</a></li><li><a class="tocitem" href="../geometry/">Geometry</a></li><li><a class="tocitem" href="../operators/">Operators</a></li><li class="is-active"><a class="tocitem" href>Remapping</a><ul class="internal"><li><a class="tocitem" href="#Non-conservative-remapping"><span>Non-conservative remapping</span></a></li><li><a class="tocitem" href="#Conservative-remapping-with-TempestRemap"><span>Conservative remapping with <code>TempestRemap</code></span></a></li></ul></li><li><a class="tocitem" href="../matrix_fields/">MatrixFields</a></li><li><a class="tocitem" href="../api/">API</a></li><li><input class="collapse-toggle" id="menuitem-10" type="checkbox"/><label class="tocitem" for="menuitem-10"><span class="docs-label">Developer docs</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../performance_tips/">Performance tips</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-11" type="checkbox"/><label class="tocitem" for="menuitem-11"><span class="docs-label">Tutorials</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../tutorials/introduction/">Introduction to ClimaCore.jl</a></li></ul></li><li><a class="tocitem" href="../examples/">Examples</a></li><li><a class="tocitem" href="../debugging/">Debugging</a></li><li><input class="collapse-toggle" id="menuitem-14" type="checkbox"/><label class="tocitem" for="menuitem-14"><span class="docs-label">Libraries</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../lib/ClimaCorePlots/">ClimaCorePlots.jl</a></li><li><a class="tocitem" href="../lib/ClimaCoreMakie/">ClimaCoreMakie.jl</a></li><li><a class="tocitem" href="../lib/ClimaCoreVTK/">ClimaCoreVTK.jl</a></li><li><a class="tocitem" href="../lib/ClimaCoreTempestRemap/">ClimaCoreTempestRemap.jl</a></li><li><a class="tocitem" href="../lib/ClimaCoreSpectra/">ClimaCoreSpectra.jl</a></li></ul></li><li><a class="tocitem" href="../Contributing/">Contributing guide</a></li><li><a class="tocitem" href="../code_of_conduct/">Code of Conduct</a></li><li><a class="tocitem" href="../references/">References</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Remapping</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Remapping</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/CliMA/ClimaCore.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/CliMA/ClimaCore.jl/blob/main/docs/src/remapping.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Remapping-to-regular-grids"><a class="docs-heading-anchor" href="#Remapping-to-regular-grids">Remapping to regular grids</a><a id="Remapping-to-regular-grids-1"></a><a class="docs-heading-anchor-permalink" href="#Remapping-to-regular-grids" title="Permalink"></a></h1><p><code>ClimaCore</code> horizontal domains are spectral elements. Points are not distributed uniformly within an element, and elements are also not necessarily organized in a simple way. For these reasons, remapping to regular grids becomes a fundamental operations when inspecting the simulation output. In this section, we describe the remappers currently available in <code>ClimaCore</code>.</p><p>Broadly speaking, we can classify remappers in two categories: conservative, and non-conservative. Conservative remappers preserve areas (and masses) when interpolating from the spectral grid to Cartesian ones. Conservative remappers are non-local operations (meaning that they require communication between different elements) and are more expensive, so they are typically reserved to operations where physical conservation is important (e.g., exchange between component models in a coupled simulation). On the other hand, non-conservative remappers are local to an element and faster to evaluate, which makes them suitable to operations like diagnostics and plotting, where having perfect physical conservation is not as important.</p><h2 id="Non-conservative-remapping"><a class="docs-heading-anchor" href="#Non-conservative-remapping">Non-conservative remapping</a><a id="Non-conservative-remapping-1"></a><a class="docs-heading-anchor-permalink" href="#Non-conservative-remapping" title="Permalink"></a></h2><p>Non-conservative remappers are fast and do not require communication, but they are not as accurate as conservative remappers, especially with large elements with sharp gradients. These remappers are better suited for diagnostics and plots.</p><p>The main non-conservative remapper currently implemented utilizes a Lagrange interpolation with the barycentric formula in [Berrut2004], equation (3.2), for the horizontal interpolation. Vertical interpolation is linear except in the boundary elements where it is 0th order.</p><h3 id="Quick-start"><a class="docs-heading-anchor" href="#Quick-start">Quick start</a><a id="Quick-start-1"></a><a class="docs-heading-anchor-permalink" href="#Quick-start" title="Permalink"></a></h3><p>Assuming you have a <code>ClimaCore</code> <code>Field</code> with name <code>field</code>, the simplest way to interpolate onto a uniform grid is with</p><pre><code class="language-julia hljs">julia&gt; import ClimaCore.Remapping
julia&gt; Remapping.interpolate(field)</code></pre><p>This will return an <code>Array</code> (or a <code>CuArray</code>) with the <code>field</code> interpolated on some uniform grid that is automatically determined based on the <code>Space</code> of the given <code>field</code>. To obtain such coordinates, you can call the <code>Remapping.default_target_hcoords</code> and <code>Remapping.default_target_zcoords</code> functions. These functions return an <code>Array</code> with the coordinates over which interpolation will occur. These arrays are of type <code>Geometry.Point</code>s.</p><p><code>ClimaCore.Remapping.interpolate</code> allocates new output arrays. As such, it is not suitable for performance-critical applications. <code>ClimaCore.Remapping.interpolate!</code> performs interpolation in-place. When using the in-place version<code>, the</code>dest<code>ination has to have the same array type as the device in use (e.g.,</code>CuArray<code>for CUDA runs) and has to be</code>nothing<code>for non-root processes. For performance-critical applications, it is preferable to a</code>ClimaCore.Remapping.Remapper` and use it directly (see next Section).</p><h4 id="Example"><a class="docs-heading-anchor" href="#Example">Example</a><a id="Example-1"></a><a class="docs-heading-anchor-permalink" href="#Example" title="Permalink"></a></h4><p>Given <code>field</code>, a <code>Field</code> defined on a cubed sphere.</p><p>By default, a target uniform grid is chosen (with resolution <code>hresolution</code> and <code>vresolution</code>), so remapping is</p><pre><code class="language-julia hljs">interpolated_array = interpolate(field, hcoords, zcoords)</code></pre><p>Coordinates can be specified:</p><pre><code class="language-julia hljs">longpts = range(-180.0, 180.0, 21)
latpts = range(-80.0, 80.0, 21)
zpts = range(0.0, 1000.0, 21)

hcoords = [Geometry.LatLongPoint(lat, long) for long in longpts, lat in latpts]
zcoords = [Geometry.ZPoint(z) for z in zpts]

interpolated_array = interpolate(field, hcoords, zcoords)</code></pre><p>The output is defined on the Cartesian product of <code>hcoords</code> with <code>zcoords</code>.</p><p>If the default target coordinates are being used, it is possible to broadcast <code>ClimaCore.Geometry.components</code> to extract them as a vector of tuples (and then broadcast <code>getindex</code> to extract the respective coordinates as vectors).</p><h3 id="The-Remapper-object"><a class="docs-heading-anchor" href="#The-Remapper-object">The <code>Remapper</code> object</a><a id="The-Remapper-object-1"></a><a class="docs-heading-anchor-permalink" href="#The-Remapper-object" title="Permalink"></a></h3><p>A <code>Remapping.Remapper</code> is an object that is tied to a specified <code>Space</code> and can interpolate scalar <code>Field</code>s defined on that space onto a predefined target grid. The grid does not have to be regular, but it has to be defined as a Cartesian product between some horizontal and vertical coordinates (meaning, for each horizontal point, there is a fixed column of vertical coordinates).</p><p>Let us create our first remapper, assuming we have <code>space</code> defined on the surface of the sphere</p><pre><code class="language-julia hljs">import ClimaCore.Geometry: LatLongPoint, ZPoint
import ClimaCore.Remapping: Remapper

hcoords = [Geometry.LatLongPoint(lat, long) for long in -180.:180., lat in -90.:90.]
remapper = Remapper(space, target_hcoords)</code></pre><p>This <code>remapper</code> object knows can interpolate <code>Field</code>s defined on <code>space</code> with the same <code>interpolate</code> and <code>interpolate!</code> functions.</p><pre><code class="language-julia hljs">import ClimaCore.Fields: coordinate_field
import ClimaCore.Remapping: interpolate, interpolate!

example_field = coordinate_field(space)
interpolated_array = interpolate(remapper, example_field)

# Interpolate in place
interpolate!(interpolated_array, remapper, example_field)</code></pre><p>Multiple fields defined on the same space can be interpolate at the same time</p><pre><code class="language-julia hljs">example_field2 = cosd.(example_field)
interpolated_arrays = interpolate(remapper, [example_field, example_field2])</code></pre><p>When interpolating multiple fields, greater performance can be achieved by creating the <code>Remapper</code> with a larger internal buffer to store intermediate values for interpolation. Effectively, this controls how many fields can be remapped simultaneously in <code>interpolate</code>. When more fields than <code>buffer_length</code> are passed, the remapper will batch the work in sizes of <code>buffer_length</code>. The optimal number of fields passed is the <code>buffer_length</code> of the <code>remapper</code>. If more fields are passed, the <code>remapper</code> will batch work with size up to its <code>buffer_length</code>.</p><h4 id="Example-2"><a class="docs-heading-anchor" href="#Example-2">Example</a><a class="docs-heading-anchor-permalink" href="#Example-2" title="Permalink"></a></h4><p>Given <code>field1</code>,<code>field2</code>, two <code>Field</code> defined on a cubed sphere.</p><pre><code class="language-julia hljs">longpts = range(-180.0, 180.0, 21)
latpts = range(-80.0, 80.0, 21)
zpts = range(0.0, 1000.0, 21)

hcoords = [Geometry.LatLongPoint(lat, long) for long in longpts, lat in latpts]
zcoords = [Geometry.ZPoint(z) for z in zpts]

space = axes(field1)

remapper = Remapper(space, hcoords, zcoords)

int1 = interpolate(remapper, field1)
int2 = interpolate(remapper, field2)

# Or
int12 = interpolate(remapper, [field1, field2])
# With int1 = int12[1, :, :, :]</code></pre><h2 id="Conservative-remapping-with-TempestRemap"><a class="docs-heading-anchor" href="#Conservative-remapping-with-TempestRemap">Conservative remapping with <code>TempestRemap</code></a><a id="Conservative-remapping-with-TempestRemap-1"></a><a class="docs-heading-anchor-permalink" href="#Conservative-remapping-with-TempestRemap" title="Permalink"></a></h2><p>This section hasn&#39;t been written yet. You can help by writing it.</p><p>TODO: finish writing this section.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../operators/">« Operators</a><a class="docs-footer-nextpage" href="../matrix_fields/">MatrixFields »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.8.0 on <span class="colophon-date" title="Thursday 9 January 2025 16:05">Thursday 9 January 2025</span>. Using Julia version 1.10.7.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
