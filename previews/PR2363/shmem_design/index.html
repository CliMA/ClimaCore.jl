<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Shared memory design · ClimaCore.jl</title><meta name="title" content="Shared memory design · ClimaCore.jl"/><meta property="og:title" content="Shared memory design · ClimaCore.jl"/><meta property="twitter:title" content="Shared memory design · ClimaCore.jl"/><meta name="description" content="Documentation for ClimaCore.jl."/><meta property="og:description" content="Documentation for ClimaCore.jl."/><meta property="twitter:description" content="Documentation for ClimaCore.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.png" alt="ClimaCore.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../">ClimaCore.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../intro/">Introduction</a></li><li><a class="tocitem" href="../math_framework/">Mathematical Framework</a></li><li><a class="tocitem" href="../installation_instructions/">Installation and How-to Guides</a></li><li><a class="tocitem" href="../geometry/">Geometry</a></li><li><a class="tocitem" href="../operators/">Operators</a></li><li><a class="tocitem" href="../remapping/">Remapping</a></li><li><a class="tocitem" href="../matrix_fields/">MatrixFields</a></li><li><input class="collapse-toggle" id="menuitem-9" type="checkbox"/><label class="tocitem" for="menuitem-9"><span class="docs-label">API</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../APIs/utilities_api/">Utilities</a></li><li><a class="tocitem" href="../APIs/datalayouts_api/">DataLayouts</a></li><li><a class="tocitem" href="../APIs/geometry_api/">Geometry</a></li><li><a class="tocitem" href="../APIs/domains_api/">Domains</a></li><li><a class="tocitem" href="../APIs/meshes_api/">Meshes</a></li><li><a class="tocitem" href="../APIs/topologies_api/">Topologies</a></li><li><a class="tocitem" href="../APIs/grids_api/">Grids</a></li><li><a class="tocitem" href="../APIs/hypso_api/">Hypsography</a></li><li><a class="tocitem" href="../APIs/dss_api/">DSS</a></li><li><a class="tocitem" href="../APIs/common_grids_api/">CommonGrids</a></li><li><a class="tocitem" href="../APIs/spaces_api/">Spaces</a></li><li><a class="tocitem" href="../APIs/common_spaces_api/">CommonSpaces</a></li><li><a class="tocitem" href="../APIs/quadratures_api/">Quadratures</a></li><li><a class="tocitem" href="../APIs/fields_api/">Fields</a></li><li><a class="tocitem" href="../APIs/limiters_api/">Limiters</a></li><li><a class="tocitem" href="../APIs/input_output_api/">InputOutput</a></li><li><a class="tocitem" href="../APIs/remapping_api/">Remapping</a></li><li><a class="tocitem" href="../APIs/recursive_apply_api/">RecursiveApply</a></li><li><a class="tocitem" href="../APIs/devices_api/">Devices</a></li><li><a class="tocitem" href="../APIs/debug_only_api/">DebugOnly</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-10" type="checkbox" checked/><label class="tocitem" for="menuitem-10"><span class="docs-label">Developer docs</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../performance_tips/">Performance tips</a></li><li class="is-active"><a class="tocitem" href>Shared memory design</a><ul class="internal"><li><a class="tocitem" href="#Motivation"><span>Motivation</span></a></li><li><a class="tocitem" href="#High-level-design"><span>High-level design</span></a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-11" type="checkbox"/><label class="tocitem" for="menuitem-11"><span class="docs-label">Tutorials</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../tutorials/introduction/">Introduction to ClimaCore.jl</a></li></ul></li><li><a class="tocitem" href="../examples/">Examples</a></li><li><a class="tocitem" href="../masks/">Masks</a></li><li><a class="tocitem" href="../debugging/">Debugging</a></li><li><input class="collapse-toggle" id="menuitem-15" type="checkbox"/><label class="tocitem" for="menuitem-15"><span class="docs-label">Libraries</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../lib/ClimaCorePlots/">ClimaCorePlots.jl</a></li><li><a class="tocitem" href="../lib/ClimaCoreMakie/">ClimaCoreMakie.jl</a></li><li><a class="tocitem" href="../lib/ClimaCoreVTK/">ClimaCoreVTK.jl</a></li><li><a class="tocitem" href="../lib/ClimaCoreTempestRemap/">ClimaCoreTempestRemap.jl</a></li><li><a class="tocitem" href="../lib/ClimaCoreSpectra/">ClimaCoreSpectra.jl</a></li></ul></li><li><a class="tocitem" href="../Contributing/">Contributing guide</a></li><li><a class="tocitem" href="../code_of_conduct/">Code of Conduct</a></li><li><a class="tocitem" href="../faq/">Frequently asked questions</a></li><li><a class="tocitem" href="../references/">References</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Developer docs</a></li><li class="is-active"><a href>Shared memory design</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Shared memory design</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/CliMA/ClimaCore.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/CliMA/ClimaCore.jl/blob/main/docs/src/shmem_design.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Shared-memory-design"><a class="docs-heading-anchor" href="#Shared-memory-design">Shared memory design</a><a id="Shared-memory-design-1"></a><a class="docs-heading-anchor-permalink" href="#Shared-memory-design" title="Permalink"></a></h1><p>ClimaCore stencil operators support staggered (or collocated) finite difference and interpolation operations. For example, the <code>DivergenceF2C</code> operator takes an argument that lives on the cell faces and the resulting divergence calculation lives on the cell centers. Such operations are effectively matrix-vector multiplication and are often a significant portion of the runtime cost for users.</p><p>Here, we outline an optimization, shared memory (or, &quot;shmem&quot; for short), that we use to improve the performance of these operations.</p><h2 id="Motivation"><a class="docs-heading-anchor" href="#Motivation">Motivation</a><a id="Motivation-1"></a><a class="docs-heading-anchor-permalink" href="#Motivation" title="Permalink"></a></h2><p>A naive and simplified implementation of this operation looks like <code>div[i] = (f [i+1] - f[i]) / dz[i]</code>. Such a calculation on the gpu (or cpu) requires <code>f[i]</code> be read from global memory to compute the result of <code>div[i]</code> and <code>div[i-1]</code>. Not to mention, if <code>f</code> is a <code>Broadcasted</code> object (<code>Broadcasted</code> objects behave like arrays, and support <code>f[i]</code> behavior), then <code>f[i]</code> may require several reads and or computations.</p><p>Reading data from global memory is often the main bottleneck for bandwidth-limited cuda kernels. As such, we use shmem to reduce the number of global memory reads (and compute) in our kernels.</p><h2 id="High-level-design"><a class="docs-heading-anchor" href="#High-level-design">High-level design</a><a id="High-level-design-1"></a><a class="docs-heading-anchor-permalink" href="#High-level-design" title="Permalink"></a></h2><p>The high-level view of the design is:</p><ul><li>The <code>bc::StencilBroadcasted</code> type has a <code>work</code> field, which is used to store shmem for the <code>bc.op</code> operator. The element type of the <code>work</code> (or parts of <code>work</code> if there are multiple parts) is the type returned by the <code>bc.op</code>&#39;s <code>Operator.return_eltype</code>.</li><li>Recursively reconstruct the broadcasted object, allocating shmem for each <code>StencilBroadcasted</code> along the way that supports shmem (different operators require different arguments, and therefore different types and amounts of shmem).</li><li>Recursively fill the shmem for all <code>StencilBroadcasted</code>. This is done by reading the argument data from <code>getidx</code>. See the section discussion below for more details.</li><li>The destination field is filled with the result of <code>getidx</code> (as it is without shmem), except that we overload <code>getidx</code> (for supported <code>StencilBroadcasted</code> types) to retrieve the result of <code>getidx</code> via <code>fd_operator_evaluate</code>, which retrieves the result from the shmem, instead of global memory.</li></ul><h3 id="Populating-shared-memory,-and-memory-access-safety"><a class="docs-heading-anchor" href="#Populating-shared-memory,-and-memory-access-safety">Populating shared memory, and memory access safety</a><a id="Populating-shared-memory,-and-memory-access-safety-1"></a><a class="docs-heading-anchor-permalink" href="#Populating-shared-memory,-and-memory-access-safety" title="Permalink"></a></h3><p>We use tail-recursion when filling shared memory of the broadcast expressions. That is, we visit leaves of the broadcast expression, then work our way up. It&#39;s important to note that the <code>StencilBroadcasted</code> and <code>Broadcasted</code> can be interleaved.</p><p>Let&#39;s take <code>DivergenceF2C()(f*GradientC2F()(a*b)))</code> as an example (depicted in the image below).</p><p>Recursion must go through the entire expression in order to ensure that we&#39;ve reached all of the leaves of the <code>StencilBroadcasted</code> objects (otherwise, we could introduce race conditions with memory access). The leaves of the <code>StencilBroadcasted</code> will call <code>getidx</code>, below which there are (by definition) no more <code>StencilBroadcasted</code>, and those <code>getidx</code> calls will read from global memory. All subsequent reads will be from shmem(as they will be caught by the <code>getidx(parent_space, bc::StencilBroadcasted {CUDAWithShmemColumnStencilStyle}, idx, hidx)</code> defined in the <code>ClimaCoreCUDAExt</code> module).</p><p>In the diagram below, we traverse and fill the yellow highlighted sections (bottom first and top last). The algorithmic impact of using shared memory is that the duplicate global memory reads (highlighted in red circles) become one global memory read (performed in <code>fd_operator_fill_shmem!</code>).</p><p>Finally, its important to note that threads must by syncrhonized after each node in the tree is filled, to avoid race conditions for subsequent <code>getidx (parent_space, bc::StencilBroadcasted{CUDAWithShmemColumnStencilStyle}, idx, hidx)</code> calls (which are retrieved via shmem).</p><p><img src="../shmem_diagram_example.png" alt/></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../performance_tips/">« Performance tips</a><a class="docs-footer-nextpage" href="../tutorials/introduction/">Introduction to ClimaCore.jl »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.14.1 on <span class="colophon-date" title="Saturday 2 August 2025 14:12">Saturday 2 August 2025</span>. Using Julia version 1.10.10.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
