<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Masks · ClimaCore.jl</title><meta name="title" content="Masks · ClimaCore.jl"/><meta property="og:title" content="Masks · ClimaCore.jl"/><meta property="twitter:title" content="Masks · ClimaCore.jl"/><meta name="description" content="Documentation for ClimaCore.jl."/><meta property="og:description" content="Documentation for ClimaCore.jl."/><meta property="twitter:description" content="Documentation for ClimaCore.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.png" alt="ClimaCore.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../">ClimaCore.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../intro/">Introduction</a></li><li><a class="tocitem" href="../math_framework/">Mathematical Framework</a></li><li><a class="tocitem" href="../installation_instructions/">Installation and How-to Guides</a></li><li><a class="tocitem" href="../geometry/">Geometry</a></li><li><a class="tocitem" href="../operators/">Operators</a></li><li><a class="tocitem" href="../remapping/">Remapping</a></li><li><a class="tocitem" href="../matrix_fields/">MatrixFields</a></li><li><input class="collapse-toggle" id="menuitem-9" type="checkbox"/><label class="tocitem" for="menuitem-9"><span class="docs-label">API</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../APIs/utilities_api/">Utilities</a></li><li><a class="tocitem" href="../APIs/datalayouts_api/">DataLayouts</a></li><li><a class="tocitem" href="../APIs/geometry_api/">Geometry</a></li><li><a class="tocitem" href="../APIs/domains_api/">Domains</a></li><li><a class="tocitem" href="../APIs/meshes_api/">Meshes</a></li><li><a class="tocitem" href="../APIs/topologies_api/">Topologies</a></li><li><a class="tocitem" href="../APIs/grids_api/">Grids</a></li><li><a class="tocitem" href="../APIs/hypso_api/">Hypsography</a></li><li><a class="tocitem" href="../APIs/dss_api/">DSS</a></li><li><a class="tocitem" href="../APIs/common_grids_api/">CommonGrids</a></li><li><a class="tocitem" href="../APIs/spaces_api/">Spaces</a></li><li><a class="tocitem" href="../APIs/common_spaces_api/">CommonSpaces</a></li><li><a class="tocitem" href="../APIs/quadratures_api/">Quadratures</a></li><li><a class="tocitem" href="../APIs/fields_api/">Fields</a></li><li><a class="tocitem" href="../APIs/limiters_api/">Limiters</a></li><li><a class="tocitem" href="../APIs/input_output_api/">InputOutput</a></li><li><a class="tocitem" href="../APIs/remapping_api/">Remapping</a></li><li><a class="tocitem" href="../APIs/recursive_apply_api/">RecursiveApply</a></li><li><a class="tocitem" href="../APIs/devices_api/">Devices</a></li><li><a class="tocitem" href="../APIs/debug_only_api/">DebugOnly</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-10" type="checkbox"/><label class="tocitem" for="menuitem-10"><span class="docs-label">Developer docs</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../performance_tips/">Performance tips</a></li><li><a class="tocitem" href="../shmem_design/">Shared memory design</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-11" type="checkbox"/><label class="tocitem" for="menuitem-11"><span class="docs-label">Tutorials</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../tutorials/introduction/">Introduction to ClimaCore.jl</a></li></ul></li><li><a class="tocitem" href="../examples/">Examples</a></li><li class="is-active"><a class="tocitem" href>Masks</a><ul class="internal"><li><a class="tocitem" href="#Motivation"><span>Motivation</span></a></li><li><a class="tocitem" href="#User-interface"><span>User interface</span></a></li><li><a class="tocitem" href="#Example-script"><span>Example script</span></a></li><li><a class="tocitem" href="#Supported-operations-and-caveats"><span>Supported operations and caveats</span></a></li><li><a class="tocitem" href="#Temporary-work-arounds"><span>Temporary work-arounds</span></a></li><li><a class="tocitem" href="#Developer-docs"><span>Developer docs</span></a></li></ul></li><li><a class="tocitem" href="../debugging/">Debugging</a></li><li><input class="collapse-toggle" id="menuitem-15" type="checkbox"/><label class="tocitem" for="menuitem-15"><span class="docs-label">Libraries</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../lib/ClimaCorePlots/">ClimaCorePlots.jl</a></li><li><a class="tocitem" href="../lib/ClimaCoreMakie/">ClimaCoreMakie.jl</a></li><li><a class="tocitem" href="../lib/ClimaCoreVTK/">ClimaCoreVTK.jl</a></li><li><a class="tocitem" href="../lib/ClimaCoreTempestRemap/">ClimaCoreTempestRemap.jl</a></li><li><a class="tocitem" href="../lib/ClimaCoreSpectra/">ClimaCoreSpectra.jl</a></li></ul></li><li><a class="tocitem" href="../Contributing/">Contributing guide</a></li><li><a class="tocitem" href="../code_of_conduct/">Code of Conduct</a></li><li><a class="tocitem" href="../faq/">Frequently asked questions</a></li><li><a class="tocitem" href="../references/">References</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Masks</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Masks</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/CliMA/ClimaCore.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/CliMA/ClimaCore.jl/blob/main/docs/src/masks.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Masks"><a class="docs-heading-anchor" href="#Masks">Masks</a><a id="Masks-1"></a><a class="docs-heading-anchor-permalink" href="#Masks" title="Permalink"></a></h1><h2 id="Motivation"><a class="docs-heading-anchor" href="#Motivation">Motivation</a><a id="Motivation-1"></a><a class="docs-heading-anchor-permalink" href="#Motivation" title="Permalink"></a></h2><p>ClimaCore spaces, <code>SpectralElementSpace2D</code>s in particular, support masks, where users can set horizontal nodal locations where operations are skipped.</p><p>This is especially helpful for the land model, where they may have degrees of freedom over the ocean, but do not want to evaluate expressions in regions where data is missing.</p><p>Masks in ClimaCore offer a solution to this by, ahead of time prescribing regions to skip. This helps both with the ergonomics, as well as performance.</p><h2 id="User-interface"><a class="docs-heading-anchor" href="#User-interface">User interface</a><a id="User-interface-1"></a><a class="docs-heading-anchor-permalink" href="#User-interface" title="Permalink"></a></h2><p>There are two user-facing parts for ClimaCore masks:</p><ul><li>set the <code>enable_mask = true</code> keyword in the space constructor (when available), which is currently any constructor that returns/contains a <code>SpectralElementSpace2D</code>.</li><li>use <code>set_mask!</code> to set where the mask is <code>true</code> (where compute should occur) and <code>false</code> (where compute should be skipped)</li></ul><p>Here is an example</p><pre><code class="language-julia hljs">using ClimaComms
ClimaComms.@import_required_backends
import ClimaCore: Spaces, Fields
using ClimaCore.CommonSpaces
using Test

FT = Float64
ᶜspace = ExtrudedCubedSphereSpace(FT;
    z_elem = 10,
    z_min = 0,
    z_max = 1,
    radius = 10,
    h_elem = 10,
    n_quad_points = 4,
    staggering = CellCenter(),
    enable_mask = true,
)

# How to set the mask
Spaces.set_mask!(ᶜspace) do coords
    coords.lat &gt; 0.5
end
# Or
mask = Fields.Field(FT, ᶜspace)
mask .= map(cf -&gt; cf.lat &gt; 0.5 ? 0.0 : 1.0, Fields.coordinate_field(mask))
Spaces.set_mask!(ᶜspace, mask)</code></pre><p>Finally, operations over fields will be skipped where <code>mask == 0</code>, and applied where <code>mask == 1</code>:</p><pre><code class="nohighlight hljs">@. f = 1 # only applied where the mask is equal to 1</code></pre><h2 id="Example-script"><a class="docs-heading-anchor" href="#Example-script">Example script</a><a id="Example-script-1"></a><a class="docs-heading-anchor-permalink" href="#Example-script" title="Permalink"></a></h2><p>Here is a more complex script where the mask is used:</p><pre><code class="language-julia hljs">using ClimaComms
ClimaComms.@import_required_backends
import ClimaCore: Spaces, Fields, DataLayouts, Geometry, Operators
using ClimaCore.CommonSpaces
using Test

FT = Float64
ᶜspace = ExtrudedCubedSphereSpace(FT;
    z_elem = 10,
    z_min = 0,
    z_max = 1,
    radius = 10,
    h_elem = 10,
    n_quad_points = 4,
    staggering = CellCenter(),
    enable_mask = true,
)
ᶠspace = Spaces.face_space(ᶜspace)
ᶠcoords = Fields.coordinate_field(ᶠspace)

# How to set the mask
Spaces.set_mask!(ᶜspace) do coords
    coords.lat &gt; 0.5
end

# We also support the syntax `Spaces.set_mask!(::AbstractSpace, ::Field)`

# We can check the mask directly: (internals, only for demonstrative purposes)
mask = Spaces.get_mask(ᶜspace)
@test count(parent(mask.is_active)) == 4640
@test length(parent(mask.is_active)) == 9600

# Let&#39;s skip operations that use fill!
ᶜf = zeros(ᶜspace) # ignores mask
@. ᶜf = 1 # tests fill! # abides by mask

# Let&#39;s show that 4640 columns were impacted:
@test count(x-&gt;x==1, parent(ᶜf)) == 4640 * Spaces.nlevels(axes(ᶜf))
@test length(parent(ᶜf)) == 9600 * Spaces.nlevels(axes(ᶜf))

# Let&#39;s skip operations that use copyto!
ᶜz = Fields.coordinate_field(ᶜspace).z
ᶜf = zeros(ᶜspace)
@. ᶜf = 1 + 0 * ᶜz # tests copyto!

# Let&#39;s again show that 4640 columns were impacted:
@test count(x-&gt;x==1, parent(ᶜf)) == 4640 * Spaces.nlevels(axes(ᶜf))
@test length(parent(ᶜf)) == 9600 * Spaces.nlevels(axes(ᶜf))

# Let&#39;s skip operations in FiniteDifference operators
ᶠf = zeros(ᶠspace)
c = Fields.Field(FT, ᶜspace)
div = Operators.DivergenceF2C()
foo(f, cf) = cf.lat &gt; 0.5 ? zero(f) : sqrt(-1) # results in NaN in masked out regions
@. c = div(Geometry.WVector(foo(ᶠf, ᶠcoords)))

# Check that this field should never yield NaNs
@test count(isnan, parent(c)) == 0

# Doing the same thing with a space without a mask will yield NaNs:
ᶜspace_no_mask = ExtrudedCubedSphereSpace(FT;
    z_elem = 10,
    z_min = 0,
    z_max = 1,
    radius = 10,
    h_elem = 10,
    n_quad_points = 4,
    staggering = CellCenter(),
)
ᶠspace_no_mask = Spaces.face_space(ᶜspace_no_mask)
ᶠcoords_no_mask = Fields.coordinate_field(ᶠspace_no_mask)
c_no_mask = Fields.Field(FT, ᶜspace_no_mask)
ᶠf_no_mask = Fields.Field(FT, ᶠspace_no_mask)
@. c_no_mask = div(Geometry.WVector(foo(ᶠf_no_mask, ᶠcoords_no_mask)))
@test count(isnan, parent(c_no_mask)) == 49600</code></pre><h2 id="Supported-operations-and-caveats"><a class="docs-heading-anchor" href="#Supported-operations-and-caveats">Supported operations and caveats</a><a id="Supported-operations-and-caveats-1"></a><a class="docs-heading-anchor-permalink" href="#Supported-operations-and-caveats" title="Permalink"></a></h2><p>Currently, masked <em>operations</em> are only supported for <code>Fields</code> (and not <code>DataLayouts</code>) with <code>SpectralElementSpace2D</code>s. We do not yet have support for masked <code>SpectralElement1DSpace</code>s, and we will likely never offer masked operation support for <code>DataLayouts</code>, as they do not have the space, and can therefore not use the mask.</p><p>In addition, some operations with masked fields skip masked regions (i.e., mask-aware), and other operations execute everywhere (i.e., mask-unaware), effectively ignoring the mask. Here is a list of operations of mask-aware and mask-unaware:</p><ul><li><code>DataLayout</code> operations (<code>Fields.field_values(f) = 1</code>) mask-unaware (will likely never be mask-aware).</li><li><code>fill!</code> (<code>@. f = 1</code>) mask-aware</li><li>point-wise <code>copyto!</code> (<code>@. f = 1 + z</code>) mask-aware</li><li>stencil <code>copyto!</code> (<code>@. ᶜf = 1 + DivergenceF2C()(Geometry.WVector(ᶠf))</code>) mask-aware (vertical derivatives and interpolations interpolations)</li><li>spectral element operations <code>copyto!</code> (<code>@. f = 1 + Operators.Divergence()(f)</code>), where <code>Operators.Divergence</code> carries out a divergence operation in horizontal directions. mask-unaware</li><li>fieldvector operations <code>copyto!</code> (<code>@. Y += 1</code>) mask-unaware</li><li>reductions:<ul><li><code>sum</code> (mask-unaware, warning is thrown)</li><li><code>extrema</code> (mask-unaware, warning is thrown)</li><li><code>min</code> (mask-unaware, warning is thrown)</li><li><code>max</code> (mask-unaware, warning is thrown)</li></ul></li><li>field constructors (<code>copy</code>, <code>Fields.Field</code>, <code>ones</code>, <code>zeros</code>) are mask-unaware. This was a design implementation detail, users should not generally depend on the results where <code>mask == 0</code>, in case this is changed in the future. </li><li>internal array operations (<code>fill!(parent(field), 0)</code>) mask-unaware.</li></ul><h2 id="Temporary-work-arounds"><a class="docs-heading-anchor" href="#Temporary-work-arounds">Temporary work-arounds</a><a id="Temporary-work-arounds-1"></a><a class="docs-heading-anchor-permalink" href="#Temporary-work-arounds" title="Permalink"></a></h2><p>We can perform mask-aware reductions with the following work-around</p><pre><code class="language-julia hljs">using ClimaComms
ClimaComms.@import_required_backends
import ClimaCore: Spaces, Fields, DataLayouts, Geometry, Operators
using ClimaCore.CommonSpaces
using Test

FT = Float64
ᶜspace = ExtrudedCubedSphereSpace(FT;
    z_elem = 10,
    z_min = 0,
    z_max = 1,
    radius = 10,
    h_elem = 10,
    n_quad_points = 4,
    staggering = CellCenter(),
    enable_mask = true,
)
ᶠspace = Spaces.face_space(ᶜspace)
ᶠcoords = Fields.coordinate_field(ᶠspace)

# Set the mask
Spaces.set_mask!(ᶜspace) do coords
    coords.lat &gt; 0.5
end

# get the mask
mask = Spaces.get_mask(ᶜspace)

# make a field of ones
ᶜf = ones(ᶜspace) # ignores mask

# bitmask spanning datalayout
bm = DataLayouts.full_bitmask(mask, Fields.field_values(ᶜf));

# mask-unaware integral (includes jacobian weighting)
@show sum(ᶜf)

# mask-unaware sum (excludes jacobian weighting)
@show sum(Fields.field_values(ᶜf))

# mask-aware sum (excludes jacobian)
@show sum(parent(ᶜf)[bm])

# level mask
ᶜf_lev = Fields.level(ᶜf, 1);
bm_lev = DataLayouts.full_bitmask(mask, Fields.field_values(ᶜf_lev));
@show sum(parent(ᶜf_lev)[bm_lev])</code></pre><h2 id="Developer-docs"><a class="docs-heading-anchor" href="#Developer-docs">Developer docs</a><a id="Developer-docs-1"></a><a class="docs-heading-anchor-permalink" href="#Developer-docs" title="Permalink"></a></h2><p>In order to support masks, we define their types in <code>DataLayouts</code>, since  we need access to them from within kernels in <code>DataLayouts</code>. We could have made an API and kept them completely orthogonal, but that would have been a bit more complicated, also, it was convenient to make the masks themselves data layouts, so it seemed most natural for them to live there.</p><p>We have a couple types:</p><ul><li>abstract <code>AbstractMask</code> for subtyping masks and use for generic interface methods</li><li><code>NoMask</code> (the default), which is a lazy object that should effectively result in a no-op, without any loss of runtime performance</li><li><code>IJHMask</code> currently the only supported horizontal mask, which contains <code>is_active</code> (defined in <code>set_mask!</code>), <code>N</code> (the number of active columns), and maps containing indices to the <code>i, j, h</code> locations where <code>is_active</code> is true. The maps are defined in <code>set_mask_maps!</code>, allows us to launch cuda kernels to only target the active columns, and threads are not wasted on non-existent columns. The logic to handle this is relatively thin, and extends our current <code>ext/cuda/datalayouts_threadblock.jl</code> api (via <code>masked_partition</code> and <code>masked_universal_index</code>).</li></ul><p>An important note is that when we set the mask maps for active columns, the order that they are assigned can be permuted without impacting correctness, but this could have a big impact on performance on the gpu. We should investigate this.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../examples/">« Examples</a><a class="docs-footer-nextpage" href="../debugging/">Debugging »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.14.1 on <span class="colophon-date" title="Monday 13 October 2025 12:46">Monday 13 October 2025</span>. Using Julia version 1.10.10.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
